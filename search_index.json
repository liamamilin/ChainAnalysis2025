[["dune-sql.html", "Chapter 3 Dune SQL 3.1 Dune å¸¸è§è¯­æ³•ä»¥åŠä½¿ç”¨æ¡ˆä¾‹ 3.2 Dune å¸¸è§æŸ¥è¯¢ 3.3 å…¶ä»–å¸¸ç”¨æŸ¥è¯¢", " Chapter 3 Dune SQL Dune çš„ SQL æŸ¥è¯¢å¼•æ“ä¸»è¦ä¾èµ– Trinoï¼ˆå‰èº«ä¸º PrestoSQLï¼‰,Trinoï¼ˆPrestoSQLï¼‰ æ˜¯ä¸€ç§é«˜æ•ˆçš„åˆ†å¸ƒå¼æŸ¥è¯¢å¼•æ“ï¼Œä¸“é—¨ç”¨äºå¤„ç†å¤§è§„æ¨¡æ•°æ®é›†ã€‚å®ƒé€‚ç”¨äº OLAPï¼ˆåœ¨çº¿åˆ†æå¤„ç†ï¼‰åœºæ™¯ï¼Œèƒ½å¤Ÿé«˜æ•ˆæŸ¥è¯¢å­˜å‚¨åœ¨ Dune æ•°æ®ä»“åº“ä¸­çš„é“¾ä¸Šæ•°æ®ã€‚ 3.1 Dune å¸¸è§è¯­æ³•ä»¥åŠä½¿ç”¨æ¡ˆä¾‹ 3.1.1 æ’åº å‡è®¾æˆ‘æƒ³è¦æŸ¥çœ‹æŸä¸€ä¸ªåœ°å€åœ¨2024å¹´çš„ETHå¤§é¢è½¬å‡º. select --Selectåè·Ÿç€éœ€è¦æŸ¥è¯¢çš„å­—æ®µï¼Œå¤šä¸ªå­—æ®µç”¨è‹±æ–‡é€—å·åˆ†éš” block_time ,&quot;from&quot; ,&quot;to&quot; ,hash ,value /power(10,18) as value --é€šè¿‡å°†valueé™¤ä»¥/power(10,18)æ¥æ¢ç®—ç²¾åº¦ï¼Œ18æ˜¯ä»¥å¤ªåŠçš„ç²¾åº¦ from ethereum.transactions --ä» ethereum.transactionsè¡¨ä¸­è·å–æ•°æ® where block_time &gt; date(&#39;2024-01-01&#39;) --é™åˆ¶Transferæ—¶é—´æ˜¯åœ¨2024å¹´1æœˆ1æ—¥ä¹‹å and &quot;from&quot; = 0x3DdfA8eC3052539b6C9549F12cEA2C295cfF5296 --é™åˆ¶å­™å“¥çš„é’±åŒ… and value /power(10,18) &gt;1000 --é™åˆ¶ETH Transferé‡å¤§äº1000 order by block_time --åŸºäºblocktimeåšå‡åºæ’åˆ—ï¼Œå¦‚æœæƒ³é™åºæ’åˆ—éœ€è¦åœ¨æœ«å°¾åŠ desc 3.1.2 èšåˆ é€šè¿‡èšåˆå‡½æ•°è®¡ç®—æŸä¸€ä¸ªç»Ÿè®¡é‡ select sum( value /power(10,18) ) as value --å¯¹ç¬¦åˆè¦æ±‚çš„æ•°æ®çš„valueå­—æ®µæ±‚å’Œ ,max( value /power(10,18) ) as max_value --æ±‚æœ€å¤§å€¼ ,min( value /power(10,18) ) as min_value--æ±‚æœ€å°å€¼ ,count( hash ) as tx_count --å¯¹ç¬¦åˆè¦æ±‚çš„æ•°æ®è®¡æ•°ï¼Œç»Ÿè®¡æœ‰å¤šå°‘æ¡ ,count( distinct to ) as tx_to_address_count --å¯¹ç¬¦åˆè¦æ±‚çš„æ•°æ®è®¡æ•°ï¼Œç»Ÿè®¡æœ‰å¤šå°‘æ¡(æŒ‰ç…§å»å‘åœ°å€toå»é‡) from ethereum.transactions --ä» ethereum.transactionsè¡¨ä¸­è·å–æ•°æ® where block_time &gt; date(&#39;2024-01-01&#39;) --é™åˆ¶Transferæ—¶é—´æ˜¯åœ¨2024å¹´1æœˆ1æ—¥ä¹‹å and &quot;from&quot; = 0x3DdfA8eC3052539b6C9549F12cEA2C295cfF5296 and value /power(10,18) &gt; 1000 --é™åˆ¶ETH Transferé‡å¤§äº1000 3.1.3 åˆ†ç»„èšåˆ æŒ‰ç…§æ—¶é—´ç»´åº¦æ¥æŸ¥çœ‹æŸä¸€ä¸ªæŒ‡æ ‡çš„è¶‹åŠ¿. ç¬¬ä¸€æ­¥, å°†æ—¶é—´æˆ³è½¬æ¢æˆä¸ºä¸åŒæ ¼å¼ -- æŠŠç²’åº¦åˆ°ç§’çš„æ—¶é—´è½¬åŒ–ä¸ºå¤©/å°æ—¶/åˆ†é’Ÿ(ä¸ºäº†æ–¹ä¾¿åç»­æŒ‰ç…§å¤©æˆ–è€…å°æ—¶èšåˆ) select --Selectåè·Ÿç€éœ€è¦æŸ¥è¯¢çš„å­—æ®µï¼Œå¤šä¸ªå­—æ®µç”¨ç©ºæ ¼éš”å¼€ block_time --transactionså‘ç”Ÿçš„æ—¶é—´ ,date_trunc(&#39;hour&#39;,block_time) as stat_hour --è½¬åŒ–æˆå°æ—¶çš„ç²’åº¦ ,date_trunc(&#39;day&#39;,block_time) as stat_date --è½¬åŒ–æˆå¤©çš„ç²’åº¦ ,date_trunc(&#39;week&#39;,block_time) as stat_week--è½¬åŒ–æˆweekçš„ç²’åº¦ ,&quot;from&quot; ,&quot;to&quot; ,hash ,value /power(10,18) as value --é€šè¿‡å°†valueé™¤ä»¥/power(10,18)æ¥æ¢ç®—ç²¾åº¦ï¼Œ18æ˜¯ä»¥å¤ªåŠçš„ç²¾åº¦ from ethereum.transactions --ä» ethereum.transactionsè¡¨ä¸­è·å–æ•°æ® where block_time &gt; date(&#39;2024-01-01&#39;) --é™åˆ¶Transferæ—¶é—´æ˜¯åœ¨2024å¹´1æœˆ1æ—¥ä¹‹å and &quot;from&quot; = 0x3DdfA8eC3052539b6C9549F12cEA2C295cfF5296 and value /power(10,18) &gt;1000 --é™åˆ¶ETH Transferé‡å¤§äº1000 order by block_time --åŸºäºblocktimeåšå‡åºæ’åˆ—ï¼Œå¦‚æœæƒ³é™åºæ’åˆ—éœ€è¦åœ¨æœ«å°¾åŠ desc ç¬¬äºŒæ­¥ , åŸºäºå¤„ç†ä¹‹åçš„æ—¶é—´, è¿›è¡Œèšåˆ select date_trunc(&#39;day&#39;,block_time) as stat_date ,sum( value /power(10,18) ) as value --å¯¹ç¬¦åˆè¦æ±‚çš„æ•°æ®çš„valueå­—æ®µæ±‚å’Œ from ethereum.transactions --ä» ethereum.transactionsè¡¨ä¸­è·å–æ•°æ® where block_time &gt; date(&#39;2024-01-01&#39;) --é™åˆ¶Transferæ—¶é—´æ˜¯åœ¨2024å¹´1æœˆ1æ—¥ä¹‹å and &quot;from&quot; = 0x3DdfA8eC3052539b6C9549F12cEA2C295cfF5296 and value /power(10,18) &gt; 1000 --é™åˆ¶ETH Transferé‡å¤§äº1000 group by 1 order by 1 3.1.4 å­æŸ¥è¯¢ é¦–å…ˆ, æŸ¥çœ‹èŠ±è´¹çš„ETHä»·å€¼å¤šå°‘USD select block_time ,transactions_info.stat_minute as stat_minute ,&quot;from&quot; ,&quot;to&quot; ,hash ,eth_amount --é€šè¿‡å°†valueé™¤ä»¥/power(10,18)æ¥æ¢ç®—ç²¾åº¦ï¼Œ18æ˜¯ä»¥å¤ªåŠçš„ç²¾åº¦ ,price ,eth_amount * price as usd_value from ( select --Selectåè·Ÿç€éœ€è¦æŸ¥è¯¢çš„å­—æ®µï¼Œå¤šä¸ªå­—æ®µç”¨ç©ºæ ¼éš”å¼€ block_time ,date_trunc(&#39;minute&#39;,block_time) as stat_minute --æŠŠblock_timeç”¨date_truncå¤„ç†æˆåˆ†é’Ÿï¼Œæ–¹ä¾¿ä½œä¸ºä¸»é”®å»å…³è” ,&quot;from&quot; ,&quot;to&quot; ,hash ,value /power(10,18) as eth_amount --é€šè¿‡å°†valueé™¤ä»¥/power(10,18)æ¥æ¢ç®—ç²¾åº¦ï¼Œ18æ˜¯ä»¥å¤ªåŠçš„ç²¾åº¦ from ethereum.transactions --ä» ethereum.transactionsè¡¨ä¸­è·å–æ•°æ® where block_time &gt; date(&#39;2024-01-01&#39;) --é™åˆ¶Transferæ—¶é—´æ˜¯åœ¨2024å¹´1æœˆ1æ—¥ä¹‹å and &quot;from&quot; = 0x3DdfA8eC3052539b6C9549F12cEA2C295cfF5296 and value /power(10,18) &gt;1000 --é™åˆ¶ETH Transferé‡å¤§äº1000 order by block_time --åŸºäºblocktimeåšå‡åºæ’åˆ—ï¼Œå¦‚æœæƒ³é™åºæ’åˆ—éœ€è¦åœ¨æœ«å°¾åŠ desc ) transactions_info left join --è®²transactions_infoä¸price_infoçš„æ•°æ®å…³è”ï¼Œå…³è”æ–¹å¼ä¸º left join ( --prices.usdè¡¨é‡Œå­˜çš„æ˜¯åˆ†é’Ÿçº§åˆ«çš„ä»·æ ¼æ•°æ® select date_trunc(&#39;minute&#39;,minute) as stat_minute --æŠŠminuteç”¨date_truncå¤„ç†æˆåˆ†é’Ÿï¼Œæ–¹ä¾¿ä½œä¸ºä¸»é”®å»å…³è” ,price from prices.usd where blockchain = &#39;ethereum&#39; --å–ä»¥å¤ªåŠä¸Šçš„ä»·æ ¼æ•°æ® and symbol = &#39;WETH&#39; --å–WETHçš„æ•°æ® ) price_info on transactions_info.stat_minute = price_info.stat_minute --left joinå…³è”çš„ä¸»é”®ä¸ºstat_minute å¤§éƒ¨åˆ†æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦çš„æ•°æ®ä¸æ˜¯åœ¨åŒä¸€å¼ è¡¨é‡Œï¼Œæ¯”å¦‚transactionè¡¨å­˜å‚¨çš„å°±æ˜¯åªæœ‰transactionæ•°æ®ï¼Œæ²¡æœ‰ä»·æ ¼æ•°æ®ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿè®¡ç®—å‡ºtransactionå¯¹åº”USD ä»·å€¼ï¼Œé‚£å°±éœ€è¦ç”¨è”è¡¨æŸ¥è¯¢æŠŠä»·æ ¼æ•°æ®ç»™å…³è”è¿›æ¥. 3.1.5 CURRENT_TIMESTAMPå’Œ CURRENT_DATEå‡½æ•° CURRENT_TIMESTAMPå’Œ å¯ä»¥è·å–å½“å‰ç³»ç»Ÿçš„æ—¥æœŸå’Œæ—¶é—´å€¼, CURRENT_DATE ç”¨äºè·å–å½“å‰çš„æ—¥æœŸ. SELECT CURRENT_TIMESTAMP, /* å½“å‰ç³»ç»Ÿæ—¥æœŸå’Œæ—¶é—´ */ CURRENT_DATE, /* å½“å‰ç³»ç»Ÿæ—¥æœŸ */ CURRENT_DATE, /* å¯ä»¥çœç•¥æ‹¬å· */ DATE_TRUNC(&#39;day&#39;, CURRENT_TIMESTAMP) /* ä¸current_dateç›¸åŒ */ 3.1.6 dateadd å’Œdatediff å‡½æ•°dateadd(unit, value, expr)åœ¨ä¸€ä¸ªæ—¥æœŸè¡¨è¾¾å¼ä¸Šæ·»åŠ ä¸€ä¸ªçš„æ—¥æœŸæ—¶é—´å•ä½ã€‚ å‡½æ•°date_sub(startDate, numDays)ä½œç”¨ç±»ä¼¼ï¼Œä½†è¡¨ç¤ºçš„æ„æ€æ­£å¥½ç›¸åï¼Œå³è´Ÿæ•°è¡¨ç¤ºè¿”å›ä¹‹åçš„æ—¥æœŸï¼Œæ­£æ•°è¡¨ç¤ºä¹‹å‰çš„æ—¥æœŸã€‚ select date_add(&#39;MONTH&#39;, 2, current_date) -- å½“å‰æ—¥æœŸåŠ 2ä¸ªæœˆåçš„æ—¥æœŸ ,date_add(&#39;HOUR&#39;, 12, now()) -- å½“å‰æ—¥æœŸæ—¶é—´åŠ 12å°æ—¶ ,date_add(&#39;DAY&#39;, -2, current_date) -- å½“å‰æ—¥æœŸå‡å»2å¤© ,date_add(&#39;DAY&#39;, 2, current_date) -- å½“å‰æ—¥æœŸåŠ ä¸Š2å¤© ,date_add(&#39;DAY&#39;, -5, current_date) -- å½“å‰æ—¥æœŸåŠ ä¸Š-5å¤©ï¼Œç›¸å½“äºå‡å»5å¤© ,date_diff(&#39;DAY&#39;, date(&#39;2022-11-22&#39;), date(&#39;2022-11-25&#39;)) -- ç»“æŸæ—¥æœŸæ—©äºå¼€å§‹æ—¥æœŸï¼Œè¿”å›è´Ÿå€¼ ,date_diff(&#39;DAY&#39;, date(&#39;2022-11-25&#39;), date(&#39;2022-11-22&#39;)) -- ç»“æŸæ—¥æœŸæ™šäºå¼€å§‹æ—¥æœŸï¼Œè¿”å›æ­£å€¼ 3.1.7 INTERVAL Intervalæ˜¯ä¸€ç§æ•°æ®ç±»å‹ï¼Œä»¥æŒ‡å®šçš„æ—¥æœŸæ—¶é—´å•ä½è¡¨ç¤ºæŸä¸ªæ—¶é—´é—´éš”ã€‚ select now() - interval &#39;2&#39; hour -- 2ä¸ªå°æ—¶ä¹‹å‰ ,current_date - interval &#39;7&#39; day -- 7å¤©ä¹‹å‰ ,now() + interval &#39;1&#39; month -- ä¸€ä¸ªæœˆä¹‹åçš„å½“å‰æ—¶åˆ» 3.1.8 æ¡ä»¶åˆ¤æ–­ é¦–å…ˆæ˜¯CASE è¯­å¥ : -- ...çœç•¥éƒ¨åˆ†ä»£ç ... profiles_summary as ( select ( case when length(short_name) &gt;= 20 then 20 -- åŸŸåé•¿åº¦å¤§äº20æ—¶ï¼Œè§†ä¸º20å¯¹å¾… else length(short_name) -- åŸŸåé•¿åº¦å°äº20ï¼Œç›´æ¥ä½¿ç”¨å…¶é•¿åº¦å€¼ end) as name_length, -- å°†caseè¯­å¥è¯„ä¼°è¿”å›çš„ç»“æœå‘½åä¸ºä¸€ä¸ªæ–°çš„å­—æ®µ handle_type, count(*) as name_count from profile_created group by 1, 2 ), profiles_total as ( select count(*) as total_profile_count, sum(case when handle_type = &#39;Pure Digits&#39; then 1 -- ç±»å‹å€¼ç­‰äºç»™å®šå€¼ï¼Œè¿”å›1 else 0 -- ç±»å‹å€¼ä¸ç­‰äºç»™å®šå€¼ï¼Œè¿”å› 0 end ) as pure_digit_profile_count, sum(case when handle_type = &#39;Pure Letters&#39; then 1 -- ç±»å‹å€¼ç­‰äºç»™å®šå€¼ï¼Œè¿”å›1 else 0 -- ç±»å‹å€¼ä¸ç­‰äºç»™å®šå€¼ï¼Œè¿”å› 0 end ) as pure_letter_profile_count from profile_created ) -- ...çœç•¥éƒ¨åˆ†ä»£ç ... å…¶æ¬¡æ˜¯if è¡¨è¾¾å¼ select if(1 &lt; 2, &#39;a&#39;, &#39;b&#39;) -- æ¡ä»¶è¯„ä¼°ç»“æœä¸ºçœŸï¼Œè¿”å›ç¬¬ä¸€ä¸ªè¡¨è¾¾å¼ ,if(&#39;a&#39; = &#39;A&#39;, &#39;case-insensitive&#39;, &#39;case-sensitive&#39;) -- å­—ç¬¦ä¸²å€¼åŒºåˆ†å¤§å°å†™ 3.1.9 å­—ç¬¦ä¸²å¤„ç† å­—ç¬¦ä¸²æˆªå– : substring SELECT SUBSTRING(&#39;apple&#39;, 1, 2) // ap å­—ç¬¦ä¸²æ‹¼æ¥ å­—ç¬¦ä¸²çš„æ‹¼æ¥å¯ä»¥ä½¿ç”¨ concat å’Œ || å…³é”®å­— select concat(&#39;a&#39;, &#39; &#39;, &#39;b&#39;, &#39; c&#39;) -- è¿æ¥å¤šä¸ªå­—ç¬¦ä¸² , &#39;a&#39; || &#39; &#39; || &#39;b&#39; || &#39; c&#39; -- ä¸concat()åŠŸèƒ½ç›¸åŒ 3.1.10 çª—å£å‡½æ•° å¤šè¡Œæ•°æ®çš„ç»„åˆæˆä¸ºçª—å£ï¼ˆWindowï¼‰ã€‚å¯¹çª—å£ä¸­çš„ä¸€ç»„è¡Œè¿›è¡Œæ“ä½œå¹¶æ ¹æ®è¯¥ç»„è¡Œè®¡ç®—æ¯ä¸€è¡Œçš„è¿”å›å€¼çš„å‡½æ•°å«çª—å£å‡½æ•°ã€‚çª—å£å‡½æ•°å¯¹äºå¤„ç†ä»»åŠ¡å¾ˆæœ‰ç”¨ï¼Œä¾‹å¦‚è®¡ç®—ç§»åŠ¨å¹³å‡å€¼ã€è®¡ç®—ç´¯ç§¯ç»Ÿè®¡é‡æˆ–åœ¨ç»™å®šå½“å‰è¡Œçš„ç›¸å¯¹ä½ç½®çš„æƒ…å†µä¸‹è®¿é—®è¡Œçš„å€¼ã€‚ select price_date, contract_address, symbol, decimals, price, row_number() over (partition by contract_address order by price_date desc) as row_num -- æŒ‰åˆ†åŒºå•ç‹¬ç”Ÿæˆè¡Œå· from latest_token_price å‚è€ƒ : https://trino.io/docs/current/functions.html 3.2 Dune å¸¸è§æŸ¥è¯¢ 3.2.1 ERC20 ä»£å¸ä»·æ ¼ æŸ¥è¯¢ERC29ä»£å¸çš„æœ€æ–°ä»·æ ¼ prices.usdè¡¨ä¸­çš„ä»·æ ¼æ˜¯æŒ‰åˆ†é’Ÿè®°å½•çš„ï¼Œæˆ‘ä»¬åªéœ€è¦æ ¹æ®ä»£å¸çš„ç¬¦å·åŠå…¶å½’å±çš„åŒºå—é“¾å–æœ€æ–°çš„ä¸€æ¡è®°å½•å³å¯ï¼Œå¦‚æœæœ‰åˆçº¦åœ°å€ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åˆçº¦åœ°å€æ¥æŸ¥è¯¢ã€‚usd_latestè¡¨ä¸­åˆ™è®°å½•äº†æ¯ç§ä»£å¸çš„æœ€æ–°ä»·æ ¼ï¼Œæ¯ä¸ªä»£å¸åªæœ‰ä¸€è¡Œè®°å½•ã€‚ å› ä¸ºä»·æ ¼ä¿¡æ¯æŒ‰æ¯åˆ†é’Ÿæ¯ä¸ªä»£å¸ä¸€æ¡è®°å½•çš„æ–¹å¼ä¿å­˜ï¼Œå…·ä½“åˆ°æ¯ä¸€ä¸ªä»£å¸å…¶è®°å½•æ•°é‡ä¹Ÿå¾ˆåºå¤§ï¼Œæˆ‘ä»¬é€šè¿‡é™åˆ¶è¯»å–æœ€æ–°çš„éƒ¨åˆ†æ•°æ®æ¥æé«˜æŸ¥è¯¢çš„æ•ˆç‡ã€‚ç”±äºå¶å°”å¯èƒ½ä¼šå­˜åœ¨ä¸€å®šçš„å»¶è¿Ÿï¼Œä¸‹é¢çš„å®ä¾‹ä¸­æˆ‘ä»¬ä»è¿‡å»6å°æ—¶çš„è®°å½•é‡Œé¢è¯»å–æœ€æ–°çš„ä¸€æ¡ï¼Œç¡®ä¿èƒ½å–åˆ°ä»·æ ¼ã€‚ æŸ¥è¯¢æŸä¸€ä¸ªå¤§ç¬”çš„æœ€æ–°ä»·æ ¼ , è¿™é‡ŒæŸ¥è¯¢çš„æ˜¯WETHçš„ä»·æ ¼: select * from prices.usd where symbol = &#39;WETH&#39; and blockchain = &#39;ethereum&#39; and minute &gt;= now() - interval &#39;6&#39; hour order by minute desc limit 1 ä¹Ÿå¯ä»¥ä½¿ç”¨åˆçº¦åœ°å€æ¥æŸ¥è¯¢ä»·æ ¼: select * from prices.usd where contract_address = 0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2 -- WETH and minute &gt;= now() - interval &#39;6&#39; hour order by minute desc limit 1 ä»prices.usd_latestè¡¨è¯»å–æœ€æ–°ä»·æ ¼ä¿¡æ¯ï¼š select * from prices.usd_latest where symbol = &#39;WETH&#39; and blockchain = &#39;ethereum&#39; æŸ¥è¯¢å¤šä¸ªERC20ä»£å¸çš„æœ€æ–°ä»·æ ¼ ä»prices.usd_latestè¡¨è¯»å–å¤šä¸ªä»£å¸çš„æœ€æ–°ä»·æ ¼ä¿¡æ¯ï¼š select * from prices.usd_latest where symbol in (&#39;WETH&#39;, &#39;WBTC&#39;, &#39;USDC&#39;) and blockchain = &#39;ethereum&#39; ä»prices.usdè¡¨è¯»å–å¤šä¸ªä»£å¸çš„æœ€æ–°ä»·æ ¼ä¿¡æ¯ï¼š select symbol, decimals, price, minute from ( select row_number() over (partition by symbol order by minute desc) as row_num, * from prices.usd where symbol in (&#39;WETH&#39;, &#39;WBTC&#39;, &#39;USDC&#39;) and blockchain = &#39;ethereum&#39; and minute &gt;= now() - interval &#39;6&#39; hour order by minute desc ) p where row_num = 1 æŸ¥è¯¢ERC20 ä»£å¸çš„å¹³å‡æ¯æ—¥ä»·æ ¼ å½“æˆ‘ä»¬éœ€è¦æŸ¥è¯¢æŸä¸ªERC20ä»£å¸æ¯ä¸€å¤©çš„å¹³å‡ä»·æ ¼æ—¶ï¼Œåªèƒ½ä½¿ç”¨prices.usdè¡¨æ¥å®ç°ã€‚é€šè¿‡è®¾ç½®è¦æŸ¥è¯¢ä»·æ ¼çš„æ—¥æœŸèŒƒå›´ï¼ˆæˆ–è€…ä¸åŠ æ—¥æœŸèŒƒå›´å–å…¨éƒ¨æ—¥æœŸçš„æ•°æ®ï¼‰ï¼ŒæŒ‰å¤©æ±‡æ€»ï¼Œä½¿ç”¨avg()å‡½æ•°æ±‚å¾—å¹³å‡å€¼ï¼Œå°±å¯ä»¥å¾—åˆ°æŒ‰å¤©çš„ä»·æ ¼æ•°æ®ã€‚SQLå¦‚ä¸‹: select date_trunc(&#39;day&#39;, minute) as block_date, avg(price) as price from prices.usd where symbol = &#39;WETH&#39; and blockchain = &#39;ethereum&#39; and minute &gt;= date(&#39;2023-01-01&#39;) group by 1 order by 1 ä»DeFiå…‘æ¢è®°å½•ä¸­è®¡ç®—ä»·æ ¼ uneä¸Šçš„ä»·æ ¼æ•°æ®è¡¨prices.usdæ˜¯é€šè¿‡spellbookæ¥ç»´æŠ¤çš„ï¼Œé‡Œé¢å¹¶æ²¡æœ‰åŒ…æ‹¬æ‰€æœ‰æ”¯æŒçš„åŒºå—é“¾ä¸Šé¢çš„æ‰€æœ‰ä»£å¸çš„ä»·æ ¼ä¿¡æ¯ã€‚ç‰¹åˆ«æ˜¯å½“æŸä¸ªæ–°çš„ERC20ä»£å¸æ–°å‘è¡Œä¸Šå¸‚ï¼Œåœ¨DEXäº¤æ˜“æ‰€è¿›è¡Œæµé€šï¼ˆæ¯”å¦‚XENï¼‰ï¼Œæ­¤æ—¶Duneçš„ä»·æ ¼è¡¨å¹¶æ²¡æœ‰è¿™ä¸ªä»£å¸çš„æ•°æ®ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¯»å–DeFié¡¹ç›®ä¸­çš„å…‘æ¢æ•°æ®ï¼Œæ¯”å¦‚Uniswapä¸­çš„Swapæ•°æ®ï¼Œå°†å¯¹åº”ä»£å¸ä¸USDCï¼ˆæˆ–è€…WETHï¼‰ä¹‹é—´çš„å…‘æ¢ä»·æ ¼è®¡ç®—å‡ºæ¥ï¼Œå†é€šè¿‡USDCæˆ–WETHçš„ä»·æ ¼æ•°æ®æ¢ç®—å¾—åˆ°ç¾å…ƒä»·æ ¼ã€‚ with xen_price_in_usdc as ( select date_trunc(&#39;hour&#39;, evt_block_time) as block_date, &#39;XEN&#39; as symbol, &#39;0x06450dee7fd2fb8e39061434babcfc05599a6fb8&#39; as contract_address, -- XEN 18 as decimals, avg(amount1 / amount0) / pow(10, (6-18)) as price --USDC: 6 decimals, XEN: 18 decimals from ( select contract_address, abs(amount0) as amount0, abs(amount1) as amount1, evt_tx_hash, evt_block_time from uniswap_v3_ethereum.Pair_evt_Swap where contract_address = &#39;0x353bb62ed786cdf7624bd4049859182f3c1e9e5d&#39; -- XEN-USDC 1.00% Pair and evt_block_time &gt; &#39;2022-10-07&#39; and evt_block_time &gt; now() - interval &#39;30 days&#39; ) s group by 1, 2, 3, 4 ), usdc_price as ( select date_trunc(&#39;hour&#39;, minute) as block_date, avg(price) as price from prices.usd where contract_address = &#39;0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48&#39; -- USDC and minute &gt; &#39;2022-10-07&#39; and minute &gt; now() - interval &#39;30 days&#39; group by 1 ) select x.block_date, x.price * u.price as price_usd from xen_price_in_usdc x inner join usdc_price u on x.block_date = u.block_date order by x.block_date ä»DeFiäº¤æ˜“é­”æ³•è¡¨è®¡ç®—ä»·æ ¼ å¦‚æœç›¸åº”çš„DeFiäº¤æ˜“æ•°æ®å·²ç»é›†æˆåˆ°äº†dex.tradesè¡¨ä¸­ï¼Œé‚£ä¹ˆä½¿ç”¨è¯¥è¡¨æ¥è®¡ç®—ä»·æ ¼ä¼šæ›´åŠ ç®€å•ã€‚æˆ‘ä»¬å¯ä»¥å°†amount_usdä¸token_bought_amountæˆ–è€…token_sold_amountç›¸é™¤ï¼Œå¾—åˆ°å¯¹åº”ä»£å¸çš„USDä»·æ ¼ã€‚ with trade_detail as ( select block_time, tx_hash, amount_usd, token_bought_amount, token_bought_symbol, token_sold_amount, token_sold_symbol from dex.trades where project_contract_address = 0x8ad599c3a0ff1de082011efddc58f1908eb6e6d8 and block_date &gt;= now() - interval &#39;3&#39; day order by block_time desc limit 1000 ) select avg( case when token_bought_symbol = &#39;WETH&#39; then amount_usd / token_bought_amount else amount_usd / token_sold_amount end ) as price from trade_detail 3.2.2 ä»£å¸æŒæœ‰è€…ç›¸å…³æ•°æ® æœ‰æ—¶å€™, æˆ‘ä»¬è¿˜éœ€è¦æŸ¥è¯¢æŸä¸ªä»£å¸çš„æŒæœ‰è€…æ•°é‡ã€ä»£å¸æ€»ä¾›åº”é‡ï¼ˆæµé€šé‡ï¼‰ã€å„æŒæœ‰è€…çš„è´¦æˆ·ä½™é¢ï¼ˆä¾‹å¦‚æŒæœ‰æœ€å¤šçš„è´¦å·çš„ä½™é¢ï¼‰ç­‰ç›¸å…³ä¿¡æ¯ã€‚ ä¸æ¯”ç‰¹å¸é€šè¿‡æœªèŠ±è´¹çš„äº¤æ˜“äº§å‡ºï¼ˆUTXOï¼‰æ¥è·Ÿè¸ªè´¦æˆ·ä½™é¢ä¸åŒï¼Œä»¥Ethereumä¸ºä»£è¡¨çš„EVMå…¼å®¹åŒºå—é“¾ä½¿ç”¨äº†è´¦æˆ·ä½™é¢çš„æ¨¡å‹ã€‚æ¯ä¸ªè´¦å·åœ°å€æœ‰é’ˆå¯¹æ¯ç§ERC20ä»£å¸çš„è½¬å…¥è®°å½•å’Œè½¬å‡ºè®°å½•ï¼Œå°†è¿™äº›è½¬å…¥å’Œè½¬å‡ºæ•°æ®æ±‡æ€»åˆ°ä¸€èµ·ï¼Œå°±å¯ä»¥å¾—åˆ°è´¦æˆ·çš„å½“å‰ä½™é¢ã€‚ è¦æŸ¥è¯¢å•ä¸ªERC20ä»£å¸çš„è´¦æˆ·ä½™é¢ä¿¡æ¯ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“å¯¹åº”ä»£å¸çš„åˆçº¦åœ°å€ã€‚è¿™ä¸ªå¯ä»¥é€šè¿‡æŸ¥è¯¢tokens.erc20è¡¨æ¥è·å¾—ã€‚ å‡è®¾æˆ‘ä»¬æƒ³è¦çŸ¥é“DOGEåˆçº¦çš„åœ°å€: select * from tokens.erc20 where symbol = &#39;DOGE&#39; and blockchain = &#39;bnb&#39; åœ°å€ä¸º: 0xba2ae424d960c26247dd6c32edc70b295c744c43 3.2.3 æŸ¥è¯¢ä»£å¸æŒæœ‰è€…æ•°é‡å’Œä»£å¸çš„æ€»æµé€šé‡ ä¸ç®¡æ˜¯è¦è®¡ç®—æŸä¸ªè´¦æˆ·ä¸‹æŸä¸ªä»£å¸çš„ä½™é¢ï¼Œè¿˜æ˜¯è®¡ç®—æŸä¸ªä»£å¸å…¨éƒ¨æŒæœ‰è€…è´¦æˆ·ä¸‹çš„ä½™é¢ï¼Œæˆ‘ä»¬éƒ½éœ€è¦å°†è½¬å…¥è½¬å‡ºæ•°æ®åˆå¹¶åˆ°ä¸€èµ·ã€‚å¯¹äºè½¬å…¥æ•°æ®ï¼Œæˆ‘ä»¬å–toä¸ºç”¨æˆ·çš„åœ°å€ï¼Œé‡‘é¢ä¸ºæ­£æ•°ã€‚å¯¹äºè½¬å‡ºæ•°æ®ï¼Œåˆ™å–fromä¸ºç”¨æˆ·åœ°å€ï¼ŒåŒæ—¶é‡‘é¢ä¹˜ä»¥â€œ-1â€ä½¿å…¶å˜æˆè´Ÿæ•°ã€‚ select * from ( select evt_block_time, evt_tx_hash, contract_address, &quot;to&quot; as address, cast(value as decimal(38, 0)) as amount from erc20_ethereum.evt_Transfer where contract_address = 0x50d1c9771902476076ecfc8b2a83ad6b9355a4c9 union all select evt_block_time, evt_tx_hash, contract_address, &quot;from&quot; as address, -1 * cast(value as decimal(38, 0)) as amount from erc20_ethereum.evt_Transfer where contract_address = 0x50d1c9771902476076ecfc8b2a83ad6b9355a4c9 ) limit 10 -- for performance åœ¨ä¸Šé¢çš„æŸ¥è¯¢ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨union allå°†æ¯ä¸ªè´¦æˆ·åœ°å€ä¸­è½¬å…¥çš„å’Œè½¬å‡ºçš„FTT Tokenåˆå¹¶åˆ°ä¸€èµ·ï¼Œå¹¶ä¸”åªå–äº†10æ¡æ ·æœ¬æ•°æ®ã€‚æ³¨æ„æˆ‘ä»¬ä½¿ç”¨value::decimal(38, 0)å¯¹valueå­—æ®µå¯¹å€¼è¿›è¡Œäº†å¼ºåˆ¶è½¬æ¢ï¼Œå› ä¸ºç°åœ¨è¿™ä¸ªå­—æ®µæ˜¯ä»¥å­—ç¬¦ä¸²å½¢å¼ä¿å­˜çš„ï¼Œä¸åšè½¬æ¢ä¼šåœ¨è®¡ç®—æ—¶é‡åˆ°ä¸€äº›é—®é¢˜ã€‚ è¿™é‡Œåˆå¹¶åˆ°ä¸€èµ·çš„æ˜¯æ˜ç»†è½¬è´¦æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—çš„è´¦æˆ·ä½™é¢æ˜¯æ±‡æ€»æ•°æ®ï¼Œå¯ä»¥åœ¨ä¸Šè¿°æŸ¥è¯¢åŸºç¡€ä¸Šï¼Œå°†å…¶æ”¾å…¥ä¸€ä¸ªCTEå®šä¹‰ä¸­ï¼Œç„¶åé’ˆå¯¹CTEæ‰§è¡Œæ±‡æ€»ç»Ÿè®¡ã€‚è€ƒè™‘åˆ°å¾ˆå¤šä»£å¸çš„æŒæœ‰äººåœ°å€æ•°é‡å¯èƒ½å¾ˆå¤šï¼ˆå‡ ä¸‡ç”šè‡³æ›´å¤šï¼‰ï¼Œæˆ‘ä»¬é€šå¸¸å…³æ³¨çš„æ˜¯æ€»æŒæœ‰äººæ•°ã€æ€»æµé€šé‡å’ŒæŒæœ‰é‡æœ€å¤šçš„é‚£éƒ¨åˆ†åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥å°†æŒ‰åœ°å€æ±‡æ€»çš„æŸ¥è¯¢ä¹Ÿæ”¾å…¥ä¸€ä¸ªCTEä¸­ï¼Œæ–¹ä¾¿åœ¨æ­¤åŸºç¡€ä¸Šæ ¹æ®éœ€è¦åšè¿›ä¸€æ­¥çš„ç»Ÿè®¡ã€‚è¿™é‡Œæˆ‘ä»¬é¦–å…ˆç»Ÿè®¡æŒæœ‰è€…æ€»æ•°ï¼ŒæŸ¥è¯¢æ—¶æ’é™¤é‚£äº›å½“å‰ä»£å¸ä½™é¢ä¸º0çš„åœ°å€ã€‚ with transfer_detail as ( select evt_block_time, evt_tx_hash, contract_address, &quot;to&quot; as address, cast(value as decimal(38, 0)) as amount from erc20_ethereum.evt_Transfer where contract_address = 0x50d1c9771902476076ecfc8b2a83ad6b9355a4c9 union all select evt_block_time, evt_tx_hash, contract_address, &quot;from&quot; as address, -1 * cast(value as decimal(38, 0)) as amount from erc20_ethereum.evt_Transfer where contract_address = 0x50d1c9771902476076ecfc8b2a83ad6b9355a4c9 ), address_balance as ( select address, sum(amount) as balance_amount from transfer_detail group by address ) select count(*) as holder_count, sum(balance_amount / 1e18) as supply_amount from address_balance where balance_amount &gt; 0 ä¸Šé¢çš„æŸ¥è¯¢ä¸­ï¼Œæˆ‘ä»¬åœ¨address_balanceè¿™ä¸ªCTEé‡Œé¢æŒ‰åœ°å€ç»Ÿè®¡äº†è´¦æˆ·ä½™é¢ï¼Œç„¶ååœ¨æœ€åçš„æŸ¥è¯¢ä¸­è®¡ç®—å½“å‰ä½™é¢å¤§äº0çš„åœ°å€æ•°é‡ï¼ˆæŒæœ‰è€…æ•°é‡ï¼‰å’Œæ‰€æœ‰è´¦æˆ·çš„ä½™é¢æ±‡æ€»ï¼ˆæµé€šæ€»é‡ï¼‰ã€‚å› ä¸ºFTTä»£å¸çš„å°æ•°ä½æ•°æ˜¯18ä½ï¼Œæˆ‘ä»¬åœ¨è®¡ç®—supply_amountæ—¶ï¼Œå°†åŸå§‹é‡‘é¢é™¤ä»¥1e18å°±æ¢ç®—æˆäº†å¸¦æœ‰å°æ•°ä½æ•°çš„é‡‘é¢ï¼Œè¿™ä¸ªå°±æ˜¯FTTä»£å¸çš„æ€»æµé€šé‡ã€‚éœ€è¦æ³¨æ„ï¼Œä¸åŒçš„ERC20ä»£å¸æœ‰ä¸åŒçš„å°æ•°ä½æ•°ï¼Œå‰é¢æŸ¥è¯¢tokens.erc20è¡¨çš„è¿”å›ç»“æœæœ‰è¿™ä¸ªæ•°æ®ã€‚1e18æ˜¯power(10, 18)çš„ä¸€ç§ç­‰ä»·ç¼©å†™ï¼Œè¡¨ç¤ºæ±‚10çš„18æ¬¡æ–¹ã€‚ç”±äºFTTä»£å¸æœ‰2ä¸‡å¤šä¸ªæŒæœ‰åœ°å€ï¼Œè¿™ä¸ªæŸ¥è¯¢ç›¸å¯¹è€—æ—¶è¾ƒé•¿ï¼Œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ‰èƒ½æ‰§è¡Œå®Œæ¯•ã€‚ 3.2.4 æŸ¥è¯¢æŒæœ‰ä»£å¸æœ€å¤šçš„åœ°å€ å› ä¸ºæˆ‘ä»¬æŸ¥è¯¢çš„æ˜¯å•ä¸ªä»£å¸ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç¡¬ç¼–ç çš„ä»£å¸åœ°å€æ›¿æ¢ä¸ºä¸€ä¸ªæŸ¥è¯¢å‚æ•°{{token_contract_address}}ï¼Œå¹¶å°†ä¸Šé¢FTTä»£å¸çš„åˆçº¦åœ°å€è®¾ç½®ä¸ºé»˜è®¤å€¼ï¼Œè¿™æ ·å°±å¯ä»¥çµæ´»åœ°æŸ¥è¯¢ä»»æ„ä»£å¸çš„æ•°æ®äº†ã€‚ä¸‹é¢çš„æŸ¥è¯¢è¿”å›æŒæœ‰ä»£å¸æ•°é‡æœ€å¤šçš„100ä¸ªåœ°å€ï¼š with transfer_detail as ( select evt_block_time, evt_tx_hash, contract_address, &quot;to&quot; as address, cast(value as decimal(38, 0)) as amount from erc20_ethereum.evt_Transfer where contract_address = {{token_contract_address}} union all select evt_block_time, evt_tx_hash, contract_address, &quot;from&quot; as address, -1 * cast(value as decimal(38, 0)) as amount from erc20_ethereum.evt_Transfer where contract_address = {{token_contract_address}} ), address_balance as ( select address, sum(amount / 1e18) as balance_amount from transfer_detail group by address ) select address, balance_amount from address_balance order by 2 desc limit 100 è¿™é‡ŒæŸ¥çœ‹äº†æŒæœ‰é‡‘é¢æœ€å¤§çš„å‰100æŒæœ‰è€…. æˆ‘ä»¬å¯ä»¥çœ‹åˆ°, å‡ ä¸ªåœ°å€å æ®äº†å¤§é‡çš„DOGEå¸. 3.2.5 æŸ¥è¯¢ä¸åŒä»£å¸æŒæœ‰è€…çš„æŒæœ‰é‡‘é¢åˆ†å¸ƒ æŒ‰ç»éªŒæ³•åˆ™ç»Ÿè®¡åˆ†å¸ƒæƒ…å†µï¼š å› ä¸ºç»Ÿè®¡çš„æ˜¯é‡‘é¢çš„åŒºé—´åˆ†å¸ƒï¼ˆç»Ÿè®¡æ•°é‡åˆ†å¸ƒæ—¶ä¹Ÿç±»ä¼¼ï¼‰æˆ‘ä»¬å¯ä»¥é€‰æ‹©å…¸å‹çš„é‡‘é¢è¿›è¡Œåˆ†åŒºï¼š10000ä»¥ä¸Šï¼Œ1000-10000ä¹‹é—´ï¼Œ500-1000ä¹‹é—´ï¼Œ100-500ä¹‹é—´ï¼Œ10-100ä¹‹é—´ï¼Œ1-10ä¹‹é—´ï¼Œä»¥åŠå°äº1ç­‰ã€‚ with transfer_detail as ( -- Same as previous sample ), address_balance as ( select address, sum(amount / 1e18) as balance_amount from transfer_detail group by address ) select (case when balance_amount &gt;= 10000 then &#39;&gt;= 10000&#39; when balance_amount &gt;= 1000 then &#39;&gt;= 1000&#39; when balance_amount &gt;= 500 then &#39;&gt;= 500&#39; when balance_amount &gt;= 100 then &#39;&gt;= 100&#39; when balance_amount &gt;= 10 then &#39;&gt;= 10&#39; when balance_amount &gt;= 1 then &#39;&gt;= 1&#39; else &#39;&lt; 1.0&#39; end) as amount_area_type, (case when balance_amount &gt;= 10000 then 10000 when balance_amount &gt;= 1000 then 1000 when balance_amount &gt;= 500 then 500 when balance_amount &gt;= 100 then 100 when balance_amount &gt;= 10 then 10 when balance_amount &gt;= 1 then 1 else 0 end) as amount_area_id, count(address) as holder_count, avg(balance_amount) as average_balance_amount from address_balance group by 1, 2 order by 2 desc è¿™æ ·å°±å¯ä»¥æŸ¥è¯¢å‡º, ä¸åŒé‡‘é¢åŒºé—´å†…, æœ‰å¤šå°‘çš„äºº. 3.3 å…¶ä»–å¸¸ç”¨æŸ¥è¯¢ 3.3.1 ä½¿ç”¨CTEè‡ªå®šä¹‰æ•°æ®è¡¨ å¯¹äºä¸€äº›æ¥æºå¤–éƒ¨æ•°æ®æºçš„æ•°æ®æˆ–è€…æ‰‹åŠ¨æ•´ç†çš„å°‘é‡æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘åœ¨æŸ¥è¯¢å†…ä½¿ç”¨CTEæ¥ç”Ÿæˆè‡ªå®šä¹‰æ•°æ®åˆ—è¡¨ with raydium_lp_pairs(account_key, pair_name) as ( values (&#39;58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2&#39;, &#39;SOL/USDC&#39;), (&#39;7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX&#39;, &#39;SOL/USDT&#39;), (&#39;AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA&#39;, &#39;RAY/SOL&#39;), (&#39;6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg&#39;, &#39;RAY/USDC&#39;), (&#39;DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut&#39;, &#39;RAY/USDT&#39;), (&#39;GaqgfieVmnmY4ZsZHHA6L5RSVzCGL3sKx4UgHBaYNy8m&#39;, &#39;RAY/SRMSOL&#39;), (&#39;6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj&#39;, &#39;STSOL/USDC&#39;), (&#39;43UHp4TuwQ7BYsaULN1qfpktmg7GWs9GpR8TDb8ovu9c&#39;, &#39;APEX4/USDC&#39;) ) select * from raydium_lp_pairs 3.3.2 è¯»å–æ•°ç»„å’Œç»“æ„ä½“ select evt_tx_hash, deltas, token -- è¿”å›æ‹†åˆ†åçš„å­—æ®µ from balancer_v2_arbitrum.Vault_evt_PoolBalanceChanged cross join unnest(tokens) as tbl1(token) -- æ‹†åˆ†ä¸ºå¤šè¡Œï¼Œæ–°å­—æ®µå‘½åä¸º token where evt_tx_hash = 0x65a4f35d81fd789d93d79f351dc3f8c7ed220ab66cb928d2860329322ffff32c 3.3.3 è¯»å–JSONæ•°æ® select json_value(vars, &#39;lax $.to&#39;) as user_address, -- è¯»å–jsonå­—ç¬¦ä¸²ä¸­çš„ç”¨æˆ·åœ°å€ json_value(vars, &#39;lax $.handle&#39;) as handle_name, -- è¯»å–jsonå­—ç¬¦ä¸²ä¸­çš„ç”¨æˆ·æ˜µç§° call_block_time, output_0 as profile_id, call_tx_hash from lens_polygon.LensHub_call_createProfile where call_success = true limit 100 3.3.4 ERC20 ä»£å¸åœ¨åˆçº¦ä¸­çš„æµå…¥æµå‡ºæƒ…å†µ è¿½è¸ª ERC20 ä»£å¸åœ¨åˆçº¦ä¸­çš„æµå…¥æµå‡ºæƒ…å†µã€‚å®ƒå¯ä»¥å¸®åŠ©ä½ åˆ†æç‰¹å®š ERC20 ä»£å¸çš„æµåŠ¨æ€§ä»¥åŠå®ƒè¿›å…¥åˆçº¦çš„é¢‘ç‡ã€‚ WITH -- é€‰æ‹©ä»£å¸ä¿¡æ¯ï¼Œè·å–åˆçº¦åœ°å€å’ŒåŒºå—é“¾ç±»å‹ selected_tokens AS ( SELECT symbol, contract_address, blockchain, decimals FROM ( SELECT upper(tk.symbol) AS symbol, -- å°†ä»£å¸ç¬¦å·è½¬æ¢ä¸ºå¤§å†™ï¼Œç¡®ä¿ç¬¦å·åŒ¹é… tk.contract_address, tk.blockchain, tk.decimals, COALESCE(count(*),0) AS transfers -- è®¡ç®—è¿‡å» 5 å¤©å†…çš„è½¬è´¦æ•°é‡ï¼Œè‹¥æ²¡æœ‰åˆ™ä¸º 0 FROM tokens.erc20 tk -- ä» ERC20 ä»£å¸è¡¨ä¸­é€‰æ‹©ä»£å¸ LEFT JOIN evms.erc20_transfers tr ON tk.blockchain = tr.blockchain -- åŒ¹é…ç›¸åŒåŒºå—é“¾ AND tk.contract_address = tr.contract_address -- åŒ¹é…ç›¸åŒä»£å¸åˆçº¦åœ°å€ AND tr.evt_block_time &gt; now() - interval &#39;5&#39; day -- è¿‡æ»¤è¿‡å» 5 å¤©çš„è½¬è´¦æ•°æ® AND tr.blockchain = &#39;{{3. Blockchain}}&#39; -- ä»…é™æŒ‡å®šçš„åŒºå—é“¾ WHERE (&#39;{{1. Token Symbol}}&#39; = upper(tk.symbol) OR try(from_hex(&#39;{{2. Token Contract}}&#39;)) = tk.contract_address) -- æ ¹æ®ä»£å¸ç¬¦å·æˆ–åˆçº¦åœ°å€è¿‡æ»¤ AND tk.blockchain = &#39;{{3. Blockchain}}&#39; -- ç¡®ä¿ç¬¦åˆæŒ‡å®šåŒºå—é“¾ GROUP BY 1,2,3,4 ORDER BY count(*) DESC -- æŒ‰è½¬è´¦æ•°é‡é™åºæ’åˆ— LIMIT 1 -- åªé€‰æ‹©ç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€ä¸ªä»£å¸ ) UNION ALL -- å¦‚æœç”¨æˆ·è¾“å…¥äº†å¤šä¸ªåœ°å€æˆ–æ²¡æœ‰æ‰¾åˆ°ä»£å¸ï¼Œåˆ™ç›´æ¥è§£æè¾“å…¥çš„åˆçº¦åœ°å€ SELECT NULL AS symbol, from_hex(trim(c.address)) AS contract_address, -- å°†è¾“å…¥çš„åœ°å€å­—ç¬¦ä¸²è½¬æ¢ä¸ºåˆçº¦åœ°å€ &#39;{{3. Blockchain}}&#39; AS blockchain, 18 AS decimals -- é»˜è®¤ä»£å¸å°æ•°ä½ä¸º 18 FROM unnest(split(&#39;{{2. Token Contract}}&#39;,&#39;,&#39;)) AS c(address) -- å¤„ç†å¤šä¸ªåˆçº¦åœ°å€ WHERE try(from_hex(trim(c.address))) IS NOT NULL AND lower(c.address) != &#39;none&#39; -- æ’é™¤æ— æ•ˆåœ°å€ AND try(from_hex(trim(c.address))) NOT IN (SELECT DISTINCT contract_address FROM tokens.erc20) -- æ’é™¤å·²å­˜åœ¨çš„ ERC20 åˆçº¦åœ°å€ ), -- è·å–ä»£å¸çš„ä½™é¢å’Œè½¬è´¦æ•°æ® erc20_balances AS ( WITH erc20_in AS ( -- è®¡ç®—ä»£å¸å­˜å…¥çš„é‡‘é¢ SELECT to AS address, SUM(tr.value/pow(10, tk.decimals)) AS tokens_funded, -- è®¡ç®—å­˜å…¥çš„ä»£å¸æ•°é‡ SUM(CASE WHEN tr.evt_block_time &gt;= now() - interval &#39;{{4. Days}}&#39; day THEN tr.value ELSE cast(0 AS uint256) END)/pow(10, tk.decimals) AS tokens_funded_days -- è¿‡å» N å¤©çš„å­˜æ¬¾é‡‘é¢ FROM evms.erc20_transfers tr JOIN selected_tokens tk ON tk.blockchain = tr.blockchain AND tk.contract_address = tr.contract_address GROUP BY 1 ), erc20_out AS ( -- è®¡ç®—ä»£å¸æ”¯å‡ºçš„é‡‘é¢ SELECT &quot;from&quot; AS address, SUM(tr.value/pow(10, tk.decimals)) AS tokens_spent, -- è®¡ç®—æ”¯å‡ºçš„ä»£å¸æ•°é‡ SUM(CASE WHEN tr.evt_block_time &gt;= now() - interval &#39;{{4. Days}}&#39; day THEN tr.value ELSE cast(0 AS uint256) END)/pow(10, tk.decimals) AS tokens_spent_days -- è¿‡å» N å¤©çš„æ”¯å‡ºé‡‘é¢ FROM evms.erc20_transfers tr JOIN selected_tokens tk ON tk.blockchain = tr.blockchain AND tk.contract_address = tr.contract_address GROUP BY 1 ) -- è®¡ç®—æ¯ä¸ªåœ°å€çš„ä»£å¸ä½™é¢å˜åŒ–ï¼šå­˜å…¥ã€æ”¯å‡ºåŠæ€»ä½™é¢ SELECT erc20_in.address, CAST(tokens_funded AS double) - COALESCE(CAST(tokens_spent AS double), 0) AS balance, -- è®¡ç®—å½“å‰ä½™é¢ COALESCE(CAST(tokens_funded_days AS double), 0) AS balance_in, -- è®¡ç®—è¿‡å» N å¤©çš„å­˜æ¬¾é‡‘é¢ -1 * COALESCE(CAST(tokens_spent_days AS double), 0) AS balance_out -- è®¡ç®—è¿‡å» N å¤©çš„æ”¯å‡ºé‡‘é¢ FROM erc20_in LEFT JOIN erc20_out ON erc20_in.address = erc20_out.address WHERE CAST(tokens_funded AS double) - COALESCE(CAST(tokens_spent AS double), 0) &gt; 0 -- åªä¿ç•™ä½™é¢å¤§äº 0 çš„åœ°å€ ) -- æŸ¥è¯¢æœ€ç»ˆç»“æœï¼Œå±•ç¤ºä»£å¸çš„ä½™é¢å˜åŒ–å’Œåˆçº¦åç§°ç­‰ä¿¡æ¯ SELECT c.name AS contract_name, -- åˆçº¦åç§° get_href(get_chain_explorer(&#39;{{3. Blockchain}}&#39;) || &#39;/address/&#39; || CAST(b.address AS varchar), CAST(b.address AS varchar)) AS address, -- è·å–åˆçº¦åœ°å€çš„åŒºå—æµè§ˆå™¨é“¾æ¥ ROUND(b.balance, 3) AS balance, -- å½“å‰ä½™é¢ï¼ˆä¿ç•™ä¸‰ä½å°æ•°ï¼‰ ROUND(b.balance - (b.balance_in + b.balance_out), 3) AS balance_last_period, -- ä¸Šä¸€ä¸ªæ—¶é—´æ®µçš„ä½™é¢ &#39;||&#39; AS split, -- åˆ†éš”ç¬¦ b.balance_in AS tokens_in, -- å½“å‰æ—¶é—´æ®µçš„å­˜æ¬¾ b.balance_out AS tokens_out, -- å½“å‰æ—¶é—´æ®µçš„æ”¯å‡º (b.balance_in + b.balance_out) AS balance_changed -- å½“å‰æ—¶é—´æ®µçš„ä½™é¢å˜åŒ–ï¼ˆå­˜æ¬¾å’Œæ”¯å‡ºçš„æ€»å’Œï¼‰ FROM erc20_balances b LEFT JOIN evms.creation_traces cre ON cre.blockchain = &#39;{{3. Blockchain}}&#39; AND cre.address = b.address -- åŒ¹é…åˆçº¦åˆ›å»ºä¿¡æ¯ LEFT JOIN safe.safes_all sf ON sf.blockchain = &#39;{{3. Blockchain}}&#39; AND sf.address = b.address -- æ’é™¤ safes é’±åŒ… LEFT JOIN (SELECT address, blockchain, max_by(name, updated_at) AS name FROM labels.contracts GROUP BY 1,2) c ON c.blockchain = &#39;{{3. Blockchain}}&#39; AND c.address = b.address -- è·å–åˆçº¦åç§° WHERE (cre.address IS NOT NULL AND sf.address IS NULL) -- æ’é™¤ safes å’Œ EOa é’±åŒ… AND ( -- ä¿ç•™ç¬¦åˆä½™é¢é˜ˆå€¼çš„åœ°å€ b.balance &gt;= {{5. Minimum Balance Threshold}} OR b.balance - (b.balance_in + b.balance_out) &gt;= {{5. Minimum Balance Threshold}} ) ORDER BY (b.balance_in + b.balance_out) DESC; -- æŒ‰è¿›å‡ºé‡æ’åºï¼Œæ‰¾å‡ºæœ€å¤§çš„ä»£å¸å˜åŒ– æ­¤æŸ¥è¯¢çš„ä¸»è¦ç›®çš„æ˜¯ç›‘æ§æŸä¸ª ERC20 ä»£å¸åœ¨æŒ‡å®šæ—¶é—´æ®µå†…çš„æµåŠ¨æƒ…å†µï¼Œè¯†åˆ«å‡ºå¤§æˆ·ã€é’±åŒ…ä½™é¢å˜åŒ–ä»¥åŠåˆçº¦çš„æ´»åŠ¨ã€‚ 3.3.5 è¿½è¸ªç‰¹å®šé’±åŒ…åœ°å€ä½™é¢å’Œæµå…¥æµå‡ºæƒ…å†µ è¿½è¸ªç‰¹å®šé’±åŒ…åœ°å€ï¼ˆåŒ…æ‹¬é¡¶çº§æŒæœ‰è€…æˆ–æŒ‡å®šçš„åœ°å€åˆ—è¡¨ï¼‰çš„ ERC20 ä»£å¸ä½™é¢å˜åŒ–å’Œæµå…¥æµå‡ºã€‚é€‚ç”¨äºç›‘æµ‹ä»£å¸æµåŠ¨æ€§ï¼Œå°¤å…¶æ˜¯å¤§æˆ·çš„æ´»åŠ¨ã€‚ WITH -- è·å–ç¬¦åˆè¾“å…¥å‚æ•°æ¡ä»¶çš„ä»£å¸ä¿¡æ¯ï¼ˆåŒ…æ‹¬åˆçº¦åœ°å€å’ŒåŒºå—é“¾ï¼‰ selected_tokens AS ( SELECT symbol, contract_address, blockchain, decimals FROM ( SELECT upper(tk.symbol) AS symbol, -- å°†ä»£å¸ç¬¦å·è½¬æ¢ä¸ºå¤§å†™ï¼Œç¡®ä¿ç¬¦å·åŒ¹é… tk.contract_address, tk.blockchain, tk.decimals, COALESCE(count(*), 0) AS transfers -- è®¡ç®—è¿‡å»5å¤©å†…çš„è½¬è´¦æ¬¡æ•°ï¼Œè‹¥æ— åˆ™ä¸º 0 FROM tokens.erc20 tk -- ä» tokens.erc20 è¡¨ä¸­è·å–ä»£å¸æ•°æ® LEFT JOIN evms.erc20_transfers tr ON tk.blockchain = tr.blockchain -- åŒ¹é…ç›¸åŒåŒºå—é“¾ AND tk.contract_address = tr.contract_address -- åŒ¹é…ç›¸åŒä»£å¸åˆçº¦åœ°å€ AND tr.evt_block_time &gt; now() - interval &#39;5&#39; day -- ä»…é™è¿‡å» 5 å¤©çš„è½¬è´¦æ•°æ® AND tr.blockchain = &#39;{{3. Blockchain}}&#39; -- åŒ¹é…æŒ‡å®šçš„åŒºå—é“¾ WHERE (&#39;{{1. Token Symbol}}&#39; = upper(tk.symbol) OR try(from_hex(&#39;{{2. Token Contract}}&#39;)) = tk.contract_address) -- æŒ‰ä»£å¸ç¬¦å·æˆ–åˆçº¦åœ°å€è¿‡æ»¤ AND tk.blockchain = &#39;{{3. Blockchain}}&#39; -- ç¡®ä¿åŒ¹é…æŒ‡å®šåŒºå—é“¾ GROUP BY 1, 2, 3, 4 ORDER BY count(*) DESC -- æŒ‰è½¬è´¦æ¬¡æ•°é™åºæ’åˆ— LIMIT 1 -- åªé€‰æ‹©åŒ¹é…çš„ç¬¬ä¸€ä¸ªä»£å¸ ) UNION ALL -- å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä»£å¸ï¼Œåˆ™è§£æè¾“å…¥çš„åˆçº¦åœ°å€ SELECT NULL AS symbol, from_hex(trim(c.address)) AS contract_address, -- å°†è¾“å…¥çš„åœ°å€å­—ç¬¦ä¸²è½¬æ¢ä¸ºåˆçº¦åœ°å€ &#39;{{3. Blockchain}}&#39; AS blockchain, 18 AS decimals -- é»˜è®¤ä»£å¸å°æ•°ä½ä¸º 18 FROM unnest(split(&#39;{{2. Token Contract}}&#39;,&#39;,&#39;)) AS c(address) -- å¤„ç†å¯èƒ½ä¼ å…¥çš„å¤šä¸ªåˆçº¦åœ°å€ WHERE try(from_hex(trim(c.address))) IS NOT NULL AND lower(c.address) != &#39;none&#39; -- æ’é™¤æ— æ•ˆåœ°å€ AND try(from_hex(trim(c.address))) NOT IN (SELECT DISTINCT contract_address FROM tokens.erc20) -- æ’é™¤å·²å­˜åœ¨çš„ ERC20 åˆçº¦åœ°å€ ), -- è·å–æ¯ä¸ªåœ°å€çš„ä»£å¸ä½™é¢å’Œè½¬è´¦æ•°æ® erc20_balances AS ( WITH erc20_in AS ( -- è®¡ç®—ä»£å¸çš„å­˜æ¬¾ SELECT to AS address, SUM(tr.value / pow(10, tk.decimals)) AS tokens_funded, -- è®¡ç®—å­˜å…¥çš„ä»£å¸æ•°é‡ SUM(CASE WHEN tr.evt_block_time &gt;= now() - interval &#39;{{4. Days}}&#39; day THEN tr.value ELSE CAST(0 AS uint256) END) / pow(10, tk.decimals) AS tokens_funded_days -- è¿‡å» N å¤©å†…çš„å­˜æ¬¾ FROM evms.erc20_transfers tr JOIN selected_tokens tk ON tk.blockchain = tr.blockchain AND tk.contract_address = tr.contract_address GROUP BY 1 ), erc20_out AS ( -- è®¡ç®—ä»£å¸çš„æ”¯å‡º SELECT &quot;from&quot; AS address, SUM(tr.value / pow(10, tk.decimals)) AS tokens_spent, -- è®¡ç®—æ”¯å‡ºçš„ä»£å¸æ•°é‡ SUM(CASE WHEN tr.evt_block_time &gt;= now() - interval &#39;{{4. Days}}&#39; day THEN tr.value ELSE CAST(0 AS uint256) END) / pow(10, tk.decimals) AS tokens_spent_days -- è¿‡å» N å¤©å†…çš„æ”¯å‡º FROM evms.erc20_transfers tr JOIN selected_tokens tk ON tk.blockchain = tr.blockchain AND tk.contract_address = tr.contract_address GROUP BY 1 ) -- è®¡ç®—æ¯ä¸ªåœ°å€çš„ä»£å¸ä½™é¢ï¼ˆå­˜å…¥å‡å»æ”¯å‡ºï¼‰ SELECT erc20_in.address, CAST(tokens_funded AS double) - COALESCE(CAST(tokens_spent AS double), 0) AS balance, -- å½“å‰ä½™é¢ï¼ˆå­˜å…¥ - æ”¯å‡ºï¼‰ COALESCE(CAST(tokens_funded_days AS double), 0) AS balance_in, -- å½“å‰æ—¶é—´æ®µçš„å­˜æ¬¾ -1 * COALESCE(CAST(tokens_spent_days AS double), 0) AS balance_out -- å½“å‰æ—¶é—´æ®µçš„æ”¯å‡º FROM erc20_in LEFT JOIN erc20_out ON erc20_in.address = erc20_out.address WHERE CAST(tokens_funded AS double) - COALESCE(CAST(tokens_spent AS double), 0) &gt; 0 -- åªä¿ç•™ä½™é¢å¤§äº 0 çš„åœ°å€ ) -- æœ€ç»ˆç»“æœæŸ¥è¯¢ï¼šå±•ç¤ºä»£å¸çš„ä½™é¢ã€è¿›å‡ºå˜åŒ–ä»¥åŠé’±åŒ…ç±»å‹ç­‰ä¿¡æ¯ SELECT CASE WHEN b.balance &gt;= {{5. Minimum Balance Threshold}} AND b.balance - (b.balance_in + b.balance_out) &gt;= {{5. Minimum Balance Threshold}} THEN &#39;âšª old&#39; -- å¦‚æœå½“å‰ä½™é¢å’Œä½™é¢å˜åŒ–éƒ½å¤§äºé˜ˆå€¼ï¼Œæ ‡è®°ä¸º &#39;old&#39; WHEN b.balance &lt; {{5. Minimum Balance Threshold}} AND b.balance - (b.balance_in + b.balance_out) &gt;= {{5. Minimum Balance Threshold}} THEN &#39;ğŸ”» removed&#39; -- å¦‚æœä½™é¢ä½äºé˜ˆå€¼ä¸”ä½™é¢å˜åŒ–å¤§äºé˜ˆå€¼ï¼Œæ ‡è®°ä¸º &#39;removed&#39; WHEN b.balance &gt;= {{5. Minimum Balance Threshold}} AND b.balance - (b.balance_in + b.balance_out) &lt; {{5. Minimum Balance Threshold}} THEN &#39;ğŸŸ¢ new&#39; -- å¦‚æœå½“å‰ä½™é¢å¤§äºé˜ˆå€¼ä½†ä½™é¢å˜åŒ–å°äºé˜ˆå€¼ï¼Œæ ‡è®°ä¸º &#39;new&#39; ELSE &#39;âœ… manually tracked&#39; -- å¦‚æœæ˜¯æ‰‹åŠ¨è·Ÿè¸ªçš„åœ°å€ï¼Œæ ‡è®°ä¸º &#39;manually tracked&#39; END AS address_type, -- é’±åŒ…ç±»å‹ï¼ˆåŸºäºä½™é¢æƒ…å†µï¼‰ CASE WHEN sf.address IS NOT NULL THEN &#39;Multisig&#39; -- å¦‚æœæ˜¯å¤šç­¾é’±åŒ…ï¼Œæ ‡è®°ä¸º &#39;Multisig&#39; WHEN cex.address IS NOT NULL THEN &#39;CEX&#39; -- å¦‚æœæ˜¯ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€åœ°å€ï¼Œæ ‡è®°ä¸º &#39;CEX&#39; ELSE &#39;EOA Wallet&#39; -- å¦åˆ™ï¼Œæ ‡è®°ä¸ºæ™®é€šå¤–éƒ¨æ‹¥æœ‰è´¦æˆ·ï¼ˆEOAï¼‰ END AS wallet_type, -- é’±åŒ…ç±»å‹ï¼ˆMultisigã€CEX æˆ– EOAï¼‰ ens.name AS ens, -- æ˜¾ç¤ºé’±åŒ…çš„ ENS åç§°ï¼ˆå¦‚æœæœ‰ï¼‰ get_href(get_chain_explorer(&#39;{{3. Blockchain}}&#39;) || &#39;/address/&#39; || CAST(b.address AS varchar), CAST(b.address AS varchar)) AS address, -- ç”ŸæˆåŒºå—é“¾åœ°å€çš„é“¾æ¥ ROUND(b.balance, 3) AS balance, -- å½“å‰ä½™é¢ï¼ˆä¿ç•™ä¸‰ä½å°æ•°ï¼‰ ROUND(b.balance - (b.balance_in + b.balance_out), 3) AS balance_last_period, -- ä¸Šä¸€å‘¨æœŸçš„ä½™é¢ï¼ˆåŸºäºå­˜æ¬¾å’Œæ”¯å‡ºå˜åŒ–ï¼‰ &#39;||&#39; AS split, -- åˆ†éš”ç¬¦ b.balance_in AS tokens_in, -- å½“å‰æ—¶é—´æ®µçš„å­˜æ¬¾ b.balance_out AS tokens_out, -- å½“å‰æ—¶é—´æ®µçš„æ”¯å‡º (b.balance_in + b.balance_out) AS balance_changed -- å½“å‰æ—¶é—´æ®µçš„ä½™é¢å˜åŒ–ï¼ˆå­˜æ¬¾ + æ”¯å‡ºï¼‰ FROM erc20_balances b LEFT JOIN evms.creation_traces cre ON cre.blockchain = &#39;{{3. Blockchain}}&#39; AND cre.address = b.address -- åŒ¹é…åˆçº¦åˆ›å»ºä¿¡æ¯ LEFT JOIN safe.safes_all sf ON sf.blockchain = &#39;{{3. Blockchain}}&#39; AND sf.address = b.address -- æ’é™¤ safes é’±åŒ… LEFT JOIN labels.ens ens ON ens.address = b.address -- è·å– ENS åœ°å€ LEFT JOIN labels.cex cex ON cex.address = b.address AND cex.blockchain = &#39;{{3. Blockchain}}&#39; -- è·å–ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ä¿¡æ¯ WHERE (cre.address IS NULL OR sf.address IS NOT NULL) -- æ’é™¤æ™®é€šåˆçº¦ï¼Œé™¤éå®ƒæ˜¯ä¸€ä¸ª safes é’±åŒ… AND ( -- ä¿ç•™ç¬¦åˆä½™é¢é˜ˆå€¼æˆ–æ‰‹åŠ¨è·Ÿè¸ªçš„åœ°å€ b.balance &gt;= {{5. Minimum Balance Threshold}} OR b.balance - (b.balance_in + b.balance_out) &gt;= {{5. Minimum Balance Threshold}} OR contains(split(replace(&#39;{{6. Manually Tracked Addresses}}&#39;,&#39; &#39;,&#39;&#39;),&#39;,&#39;), CAST(b.address AS varchar)) ) ORDER BY (b.balance_in + b.balance_out) DESC; -- æŒ‰è¿›å‡ºé‡æ’åºï¼Œæ‰¾å‡ºæœ€æ´»è·ƒçš„åœ°å€ 3.3.6 è¿½è¸ª NFT ä»£å¸ï¼ˆERC721 æˆ– ERC1155ï¼‰åœ¨åˆçº¦ä¸­çš„æµå…¥æµå‡ºæƒ…å†µ è¿½è¸ª NFT ä»£å¸ï¼ˆERC721 æˆ– ERC1155ï¼‰åœ¨åˆçº¦ä¸­çš„æµå…¥æµå‡ºæƒ…å†µã€‚è¯¥æ¨¡æ¿é€‚ç”¨äºç›‘æ§ NFT èµ„äº§çš„æµåŠ¨ã€‚ 3.3.7 ç›‘æ§æŒ‡å®šåœ°å€ï¼ˆå¦‚å¤§æˆ·æˆ–ç‰¹å®šç”¨æˆ·ï¼‰çš„ NFT ä»£å¸ä½™é¢å˜åŒ– ç›‘æ§æŒ‡å®šåœ°å€ï¼ˆå¦‚å¤§æˆ·æˆ–ç‰¹å®šç”¨æˆ·ï¼‰çš„ NFT ä»£å¸ä½™é¢å˜åŒ–ï¼Œå¸®åŠ©åˆ†æ NFT æŒæœ‰è€…çš„å˜åŒ–æƒ…å†µå’ŒæµåŠ¨æ€§ã€‚ with --this is all to get the contract_address and blockchain of the inputted params selected_tokens as ( SELECT name, contract_address, blockchain, standard FROM ( SELECT COALESCE(upper(tk.name), upper(tk.symbol)) as name , tk.contract_address , tk.blockchain , tk.standard , sum(COALESCE(amount_usd,0)) as trade_value FROM tokens.nft tk LEFT JOIN nft.trades trd ON tk.blockchain = trd.blockchain AND tk.contract_address = trd.nft_contract_address AND trd.block_time &gt; now() - interval &#39;5&#39; day --should be good enough time filter AND trd.blockchain = &#39;{{3. Blockchain}}&#39; WHERE ( &#39;{{1. NFT Collection Name}}&#39; = COALESCE(upper(tk.name), upper(tk.symbol)) OR try(from_hex(&#39;{{2. NFT Contract}}&#39;)) = tk.contract_address ) and tk.blockchain = &#39;{{3. Blockchain}}&#39; group by 1,2,3,4 order by count(*) desc limit 1 ) UNION ALL SELECT null as name , from_hex(trim(c.address)) as contract_address , &#39;{{3. Blockchain}}&#39; as blockchain , case when (SELECt distinct contract_address FROM nft.transfers WHERE blockchain = &#39;{{3. Blockchain}}&#39; and contract_address = from_hex(trim(c.address)) and token_standard = &#39;erc1155&#39; ) is not null then &#39;erc1155&#39; else &#39;erc721&#39; end as standard FROM unnest(split(&#39;{{2. NFT Contract}}&#39;,&#39;,&#39;)) as c(address) WHERE try(from_hex(trim(c.address))) is not null and lower(c.address) != &#39;none&#39; and try(from_hex(trim(c.address))) not in (SELECT distinct contract_address FROM tokens.nft) ) --now we grab balances and latest transfers for a set of tokens , nft_balances as ( WITH nft_in as ( SELECT to as address , sum(amount) as tokens_funded , SUM(case when tr.block_time &gt;= now() - interval &#39;{{4. Days}}&#39; day then amount else cast(0 as uint256) end) as tokens_funded_days FROM nft.transfers tr JOIN selected_tokens tk ON tk.blockchain = tr.blockchain and tk.contract_address = tr.contract_address GROUP BY 1 ), nft_out as ( SELECT &quot;from&quot; as address , sum(amount) as tokens_spent , SUM(case when tr.block_time &gt;= now() - interval &#39;{{4. Days}}&#39; day then amount else cast(0 as uint256) end) as tokens_spent_days FROM nft.transfers tr JOIN selected_tokens tk ON tk.blockchain = tr.blockchain and tk.contract_address = tr.contract_address GROUP BY 1 ) SELECT nft_in.address , cast(tokens_funded as double) - COALESCE(cast(tokens_spent as double), 0) as balance , COALESCE(cast(tokens_funded_days as double),0) as balance_in , -1*COALESCE(cast(tokens_spent_days as double), 0) as balance_out FROM nft_in LEFT JOIN nft_out ON nft_in.address = nft_out.address WHERE cast(tokens_funded as double) - COALESCE(cast(tokens_spent as double), 0) &gt; 0 ) SELECT case when b.balance &gt;= {{5. Minimum Balance Threshold}} and b.balance - (b.balance_in + b.balance_out) &gt;= {{5. Minimum Balance Threshold}} then &#39;âšª old&#39; when b.balance &lt; {{5. Minimum Balance Threshold}} and b.balance - (b.balance_in + b.balance_out) &gt;= {{5. Minimum Balance Threshold}} then &#39;ğŸ”» removed&#39; when b.balance &gt;= {{5. Minimum Balance Threshold}} and b.balance - (b.balance_in + b.balance_out) &lt; {{5. Minimum Balance Threshold}} then &#39;ğŸŸ¢ new&#39; else &#39;âœ… manually tracked&#39; end as address_type , case when sf.address is null then &#39;EOA wallet&#39; else &#39;Multisig&#39; end as wallet_type , ens.name as ens , get_href(get_chain_explorer(&#39;{{3. Blockchain}}&#39;) || &#39;/address/&#39; || cast(b.address as varchar), cast(b.address as varchar)) as address , round(b.balance,3) as balance , round(b.balance - (b.balance_in + b.balance_out),3) as balance_last_period , &#39;||&#39; as split , b.balance_in as tokens_in , b.balance_out as tokens_out , (b.balance_in + b.balance_out) as balance_changed FROM nft_balances b LEFT JOIN evms.creation_traces cre ON cre.blockchain = &#39;{{3. Blockchain}}&#39; and cre.address = b.address LEFT JOIN safe.safes_all sf ON sf.blockchain = &#39;{{3. Blockchain}}&#39; and sf.address = b.address LEFT JOIN labels.ens ens ON ens.address = b.address WHERE (cre.address is null or sf.address is not null) --remove contracts unless it is a safe AND --keep all wallets that either are a whale this period or last, or are manually tracked ( b.balance &gt;= {{5. Minimum Balance Threshold}} OR b.balance - (b.balance_in + b.balance_out) &gt;= {{5. Minimum Balance Threshold}} OR contains(split(replace(&#39;{{6. Manually Tracked Addresses}}&#39;,&#39; &#39;,&#39;&#39;),&#39;,&#39;), cast(b.address as varchar)) ) order by (b.balance_in + b.balance_out) desc 3.3.8 è¿½è¸ª å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ï¼ˆDEXï¼‰ ä¸Šçš„ ERC20 ä»£å¸äº¤æ˜“æ•°æ® è¿½è¸ª å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ï¼ˆDEXï¼‰ ä¸Šçš„ ERC20 ä»£å¸äº¤æ˜“æ•°æ®ã€‚å®ƒèƒ½å¤Ÿæä¾› äº¤æ˜“ä»·æ ¼ã€äº¤æ˜“é‡ã€äº¤æ˜“è€… å’Œ CEXï¼ˆä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ï¼‰ çš„èµ„é‡‘æµå‘æ•°æ®ã€‚æ­¤æ¨¡æ¿é€‚ç”¨äºå¸‚åœºåˆ†æå’Œäº¤æ˜“é‡ç›‘æµ‹ã€‚ with --this is all to get the contract_address and blockchain of the inputted params selected_tokens as ( SELECT distinct symbol, contract_address, blockchain, decimals FROM ( SELECT symbol , blockchain , max_by(contract_address, transfers) as contract_address , max_by(decimals, transfers) as decimals FROM ( SELECT upper(tk.symbol) as symbol , tk.contract_address , tk.blockchain , tk.decimals , COALESCE(count(*),0) as transfers FROM tokens.erc20 tk LEFT JOIN evms.erc20_transfers tr ON tk.blockchain = tr.blockchain AND tk.contract_address = tr.contract_address AND tr.evt_block_time &gt; now() - interval &#39;5&#39; day --should be good enough time filter AND tr.blockchain = &#39;{{3. Blockchain}}&#39; WHERE contains(split(replace(&#39;{{1. Token Symbols}}&#39;,&#39; &#39;,&#39;&#39;),&#39;,&#39;), upper(tk.symbol)) and tk.blockchain = &#39;{{3. Blockchain}}&#39; group by 1,2,3,4 ) group by 1,2 UNION ALL SELECT tk.symbol , &#39;{{3. Blockchain}}&#39; as blockchain , from_hex(trim(c.address)) as contract_address , COALESCE(tk.decimals, 18) as decimals FROM unnest(split(&#39;{{2. Token Contracts}}&#39;,&#39;,&#39;)) as c(address) LEFT JOIN tokens.erc20 tk ON tk.contract_address = try(from_hex(trim(c.address))) AND tk.blockchain = &#39;{{3. Blockchain}}&#39; WHERE try(from_hex(trim(c.address))) is not null and lower(c.address) != &#39;none&#39; and try(from_hex(trim(c.address))) not in (SELECT distinct contract_address FROM tokens.erc20) ) ) , dex_trades as ( SELECT d.token_bought_address as token_address, case when token_bought_amount != cast(token_bought_amount as double) then d.amount_usd/d.token_bought_amount else d.amount_usd/(cast(d.token_bought_amount as double)) end as price, &#39;buy&#39; as action, d.token_bought_amount as amount, d.tx_from as trader, d.block_time, d.blockchain FROM dex.trades d WHERE d.amount_usd &gt; 0 AND cast(d.token_bought_amount as double) &gt; 0 AND blockchain = &#39;{{3. Blockchain}}&#39; AND block_time &gt; now() - interval &#39;{{4. Days}}&#39; day UNION ALL SELECT d.token_sold_address as token_address, case when token_sold_amount != cast(token_sold_amount as double) then d.amount_usd/d.token_sold_amount else d.amount_usd/(cast(d.token_sold_amount as double)) end as price, &#39;sell&#39; as action, d.token_sold_amount as amount, d.tx_from as trader, d.block_time, d.blockchain FROM dex.trades d WHERE d.amount_usd &gt; 0 AND cast(d.token_sold_amount as double) &gt; 0 AND blockchain = &#39;{{3. Blockchain}}&#39; AND block_time &gt; now() - interval &#39;{{4. Days}}&#39; day ) , dex_trades_prev as ( SELECT d.token_bought_address as token_address, case when token_bought_amount != cast(token_bought_amount as double) then d.amount_usd/d.token_bought_amount else d.amount_usd/(cast(d.token_bought_amount as double)) end as price, &#39;buy&#39; as action, d.token_bought_amount as amount, d.tx_from as trader, d.block_time, d.blockchain FROM dex.trades d WHERE d.amount_usd &gt; 0 AND cast(d.token_bought_amount as double) &gt; 0 AND blockchain = &#39;{{3. Blockchain}}&#39; AND block_time &lt;= now() - interval &#39;{{4. Days}}&#39; day AND block_time &gt; now() - interval &#39;{{4. Days}}&#39; day - interval &#39;{{4. Days}}&#39; day UNION ALL SELECT d.token_sold_address as token_address, case when token_sold_amount != cast(token_sold_amount as double) then d.amount_usd/d.token_sold_amount else d.amount_usd/(cast(d.token_sold_amount as double)) end as price, &#39;sell&#39; as action, d.token_sold_amount as amount, d.tx_from as trader, d.block_time, d.blockchain FROM dex.trades d WHERE d.amount_usd &gt; 0 AND cast(d.token_sold_amount as double) &gt; 0 AND blockchain = &#39;{{3. Blockchain}}&#39; AND block_time &lt;= now() - interval &#39;{{4. Days}}&#39; day AND block_time &gt; now() - interval &#39;{{4. Days}}&#39; day - interval &#39;{{4. Days}}&#39; day ) , erc20_trade_summary as ( SELECT get_href(get_chain_explorer(&#39;{{3. Blockchain}}&#39;) || &#39;/address/&#39; || cast(tk.contract_address as varchar) , COALESCE(tk.symbol, cast(tk.contract_address as varchar)) ) as symbol , tk.contract_address , approx_percentile(tr.price,0.5) as median_price , case when approx_percentile(tr_p.price,0.5) = 0 then 0 else (approx_percentile(tr.price,0.5) - approx_percentile(tr_p.price,0.5)) / approx_percentile(tr_p.price,0.5) end as median_price_change , sum(tr.amount*tr.price) as volume_usd , case when sum(tr_p.amount*tr_p.price) = 0 then 0 else (sum(tr.amount*tr.price) - sum(tr_p.amount*tr_p.price)) / sum(tr_p.amount*tr_p.price) end as volume_usd_change , sum(case when tr.action = &#39;buy&#39; then 1 else 0 end) as buys , sum(case when tr.action = &#39;sell&#39; then 1 else 0 end) as sells , count(distinct tr.trader) as traders FROM dex_trades tr JOIN selected_tokens tk ON tr.blockchain = tk.blockchain AND tr.token_address = tk.contract_address JOIN dex_trades_prev tr_p ON tr_p.blockchain = tk.blockchain AND tr_p.token_address = tk.contract_address group by 1,2 ) , erc20_cex as ( WITH erc20_in as ( SELECT split(cex.name,&#39; &#39;)[1] as cex , tr.contract_address , SUM(tr.value/pow(10,tk.decimals)) as tokens_funded FROM evms.erc20_transfers tr JOIN selected_tokens tk ON tk.blockchain = tr.blockchain and tk.contract_address = tr.contract_address JOIN labels.cex cex ON cex.address = tr.to AND cex.blockchain = &#39;{{3. Blockchain}}&#39; WHERE tr.evt_block_time &gt;= now() - interval &#39;{{4. Days}}&#39; day GROUP BY 1,2 ), erc20_out as ( SELECT split(cex.name,&#39; &#39;)[1] as cex , tr.contract_address , SUM(tr.value/pow(10,tk.decimals)) as tokens_spent FROM evms.erc20_transfers tr JOIN selected_tokens tk ON tk.blockchain = tr.blockchain and tk.contract_address = tr.contract_address JOIN labels.cex cex ON cex.address = tr.&quot;from&quot; AND cex.blockchain = &#39;{{3. Blockchain}}&#39; WHERE tr.evt_block_time &gt;= now() - interval &#39;{{4. Days}}&#39; day GROUP BY 1,2 ) SELECT -- COALESCE(erc20_in.cex, erc20_out.cex) as cex &#39;all&#39; as cex , COALESCE(erc20_in.contract_address,erc20_out.contract_address) as contract_address , sum(COALESCE(cast(tokens_funded as double),0) - COALESCE(cast(tokens_spent as double), 0)) as cex_net_flow , sum(COALESCE(cast(tokens_funded as double),0)) as cex_inflow , sum(-1*COALESCE(cast(tokens_spent as double), 0)) as cex_outflow FROM erc20_in FULL OUTER JOIN erc20_out ON erc20_in.cex = erc20_out.cex AND erc20_in.contract_address = erc20_out.contract_address group by 1,2 ) SELECT tr.* , &#39;||&#39; as split , c.cex_inflow*median_price as cex_inflow , c.cex_outflow*median_price as cex_outflow , c.cex_net_flow*median_price as cex_net_flow FROM erc20_trade_summary tr LEFT JOIN erc20_cex c ON tr.contract_address = c.contract_address order by volume_usd desc å…¶ä»–å‚è€ƒ: https://tutorial.sixdegree.xyz/zh/zhong-ji-jiao-cheng/ch15-dunesql-introduction "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
